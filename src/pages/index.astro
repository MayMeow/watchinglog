---
import BaseLayout from "../layouts/BaseLayout.astro";
import WatchCard from "../components/WatchCard.astro";
import { getCollection } from "astro:content";

const watchEntries = (await getCollection("watchlog")).sort((a, b) => {
  const dateA = Date.parse(a.data.watchDate ?? a.data.createdAt ?? "1970-01-01");
  const dateB = Date.parse(b.data.watchDate ?? b.data.createdAt ?? "1970-01-01");
  return dateB - dateA;
});

const totals = watchEntries.reduce(
  (acc, entry) => {
    acc.total += 1;
    if (entry.data.mediaType === "movie") acc.movies += 1;
    if (entry.data.mediaType === "tv") acc.tv += 1;
    return acc;
  },
  { total: 0, movies: 0, tv: 0 }
);

const hasEntries = watchEntries.length > 0;
const latestEntry = watchEntries[0];
const latestArt = latestEntry?.data.backdropUrl ?? latestEntry?.data.posterUrl ?? null;
---
<BaseLayout title="Watching Log" description="A rolling feed of everything I'm watching.">
  <section class="watch-grid">
    {hasEntries ? (
      <div class="watch-grid__list">
        {watchEntries.map((entry) => (
          <WatchCard entry={entry} />
        ))}
      </div>
    ) : (
      <div class="watch-grid__empty">
        <p>You have not logged anything yet.</p>
        <p class="text-muted">Use the CLI to pull TMDB data and this grid will populate automatically.</p>
      </div>
    )}
  </section>
</BaseLayout>
